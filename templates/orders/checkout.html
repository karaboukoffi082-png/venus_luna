{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    :root {
        --venus-vert-nuit: #47a15bff;
        --venus-vert: #3dad4cff;
        --venus-or: #d4af37;
        --venus-jaune: #fbc02d;
    }

    .checkout-section {
        background: radial-gradient(circle at bottom right, var(--venus-vert), var(--venus-vert-nuit));
        min-height: 100vh;
        color: white;
    }

    .glass-checkout-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(212, 175, 55, 0.15);
        border-radius: 25px;
    }

    /* Style des labels et champs */
    .form-label-gold {
        color: var(--venus-jaune);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .checkout-form input, .checkout-form select, .checkout-form textarea {
        background: rgba(0, 0, 0, 0.4) !important;
        color: white !important;
        border: 1px solid rgba(212, 175, 55, 0.2) !important;
        border-radius: 12px !important;
        padding: 14px 18px !important;
        transition: 0.3s all;
    }

    .checkout-form input:focus, .checkout-form select:focus {
        border-color: var(--venus-jaune) !important;
        box-shadow: 0 0 15px rgba(251, 192, 45, 0.15) !important;
        background: rgba(0, 0, 0, 0.6) !important;
    }

    /* Panneau récapitulatif */
    .summary-card {
        border-radius: 25px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(212, 175, 55, 0.1);
        overflow: hidden;
    }

    .summary-header {
        background: rgba(212, 175, 55, 0.05);
        border-bottom: 1px solid rgba(212, 175, 55, 0.1);
        padding: 20px;
    }

    .order-item-img {
        width: 55px;
        height: 55px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid rgba(212, 175, 55, 0.3);
    }

    .btn-pay {
        background: linear-gradient(135deg, var(--venus-or), var(--venus-jaune));
        color: var(--venus-vert-nuit) !important;
        border: none;
        border-radius: 15px;
        font-weight: 800;
        letter-spacing: 1px;
        transition: 0.4s;
    }

    .btn-pay:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(212, 175, 55, 0.2);
    }

    .bkapay-notice {
        background: rgba(255, 255, 255, 0.03);
        border-left: 4px solid var(--venus-or);
        border-radius: 10px;
    }
</style>

<section class="checkout-section py-5">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="display-5 fw-bold" style="font-family: 'Playfair Display', serif;">Finaliser votre Commande</h1>
            <div style="height: 2px; width: 100px; background: var(--venus-or); margin: 15px auto;"></div>
        </div>

        <div class="row g-5">
            <div class="col-lg-7">
                <div class="glass-checkout-card p-4 p-md-5">
                    <h3 class="h5 mb-4 text-white d-flex align-items-center">
                        <i class="fas fa-map-marker-alt text-gold me-3"></i> Destination de livraison
                    </h3>
                    
                    <form method="post" class="checkout-form" id="checkout-form">
                        {% csrf_token %}
                        <div class="row g-4">
                            {% for field in form %}
                            <div class="{% if field.name == 'full_name' or field.name == 'email' or field.name == 'address' %}col-12{% else %}col-md-6{% endif %}">
                                <label class="form-label-gold">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger x-small mt-1"><i class="fas fa-exclamation-circle me-1"></i> {{ field.errors|first }}</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            <div class="col-12 mt-4">
                                <label class="form-label-gold">Zone de livraison (Lomé & Environs)</label>
                                <select class="form-select" id="zone-select" name="shipping_zone" required>
                                    <option value="0" selected disabled>Où devons-nous livrer ?</option>
                                    {% for zone in zones %}
                                    <option value="{{ zone.price }}">{{ zone.name }} (+{{ zone.price }} F)</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mt-5 p-3 bkapay-notice">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-shield-check text-gold me-2"></i>
                                <span class="small fw-bold text-white">PAIEMENT SÉCURISÉ VIA BKAPAY</span>
                            </div>
                            <p class="x-small text-white-50 mb-0">
                                Règlement instantané par **TMoney** ou **Moov Money**. Votre commande sera validée immédiatement après confirmation du transfert.
                            </p>
                        </div>

                        <button type="submit" class="btn btn-pay w-100 py-3 mt-4 text-uppercase">
                            Confirmer et Payer (<span id="btn-total">{{ total }}</span> F)
                        </button>
                    </form>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="sticky-top" style="top: 110px;">
                    <div class="summary-card shadow-lg">
                        <div class="summary-header text-center">
                            <h4 class="mb-0 h6 text-gold ls-2">VOTRE SÉLECTION</h4>
                        </div>
                        
                        <div class="p-4" style="max-height: 400px; overflow-y: auto;">
                            {% for item in items %}
                            <div class="d-flex align-items-center mb-3">
                                <div class="position-relative">
                                    <img src="{% if item.product.images.first %}{{ item.product.images.first.image.url }}{% else %}{% static 'img/default.jpg' %}{% endif %}" class="order-item-img">
                                    <span class="badge rounded-pill position-absolute top-0 start-100 translate-middle bg-gold text-dark border border-dark border-2" style="font-size: 0.65rem;">
                                        {{ item.quantity }}
                                    </span>
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <p class="small fw-bold mb-0 text-white">{{ item.name }}</p>
                                    <p class="x-small text-white-50 mb-0">Réf: #{{ item.product.id }}</p>
                                </div>
                                <div class="text-end">
                                    <span class="small fw-bold text-gold">{{ item.subtotal }} F</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="bg-black bg-opacity-30 p-4 border-top border-white border-opacity-10">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-white-50 small">Articles</span>
                                <span class="small">{{ total }} F</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-white-50 small">Livraison</span>
                                <span class="fw-bold text-gold" id="shipping-cost">0 F</span>
                            </div>
                            
                            <hr class="border-white border-opacity-10 my-3">
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="h5 mb-0 fw-bold text-white">TOTAL</span>
                                <div class="text-end">
                                    <span class="h3 fw-bold text-gold mb-0"><span id="grand-total">{{ total }}</span> F</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <p class="x-small text-white-50"><i class="fas fa-info-circle me-1"></i> Des questions ? Contactez-nous sur WhatsApp au +228 93 34 34 03</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const zoneSelect = document.getElementById('zone-select');
        const shippingDisplay = document.getElementById('shipping-cost');
        const totalDisplay = document.getElementById('grand-total');
        const btnTotal = document.getElementById('btn-total');
        
        // Nettoyage du sous-total pour le calcul
        const subtotal = parseInt("{{ total }}".replace(/\D/g, '')) || 0;

        zoneSelect.addEventListener('change', function() {
            const shipPrice = parseInt(this.value) || 0;
            const finalTotal = subtotal + shipPrice;

            // Animation de mise à jour
            shippingDisplay.innerText = shipPrice.toLocaleString() + " F";
            totalDisplay.innerText = finalTotal.toLocaleString();
            btnTotal.innerText = finalTotal.toLocaleString();
            
            // Petit effet visuel sur le prix total
            totalDisplay.classList.add('text-white');
            setTimeout(() => totalDisplay.classList.remove('text-white'), 200);
        });
    });
</script>
{% endblock %}