{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    :root {
        --venus-profond: #2d9e3cff;
        --venus-aura: #17a52eff;
        --venus-or: #d4af37;
        --venus-jaune: #fbc02d;
    }

    .sync-section {
        background: radial-gradient(circle at center, var(--venus-aura), var(--venus-profond));
        min-height: 100vh;
        display: flex;
        align-items: center;
        color: white;
        overflow: hidden;
    }

    /* Loader Mystique */
    .orb-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 40px;
    }

    .orb-core {
        width: 100%;
        height: 100%;
        border: 4px solid transparent;
        border-top-color: var(--venus-or);
        border-bottom-color: var(--venus-jaune);
        border-radius: 50%;
        animation: rotateOrb 1.5s linear infinite;
    }

    .orb-inner {
        position: absolute;
        top: 15px; left: 15px; right: 15px; bottom: 15px;
        border: 2px solid transparent;
        border-left-color: white;
        border-right-color: white;
        border-radius: 50%;
        opacity: 0.5;
        animation: rotateOrb 3s linear infinite reverse;
    }

    @keyframes rotateOrb {
        to { transform: rotate(360deg); }
    }

    .glass-sync-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(212, 175, 55, 0.15);
        border-radius: 40px;
        padding: 50px 30px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
    }

    .sync-steps {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 20px;
        padding: 25px;
        margin: 30px 0;
        border-left: 3px solid var(--venus-or);
    }

    .step-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        font-size: 0.95rem;
        opacity: 0.8;
    }

    .step-item i {
        margin-top: 4px;
        margin-right: 15px;
        color: var(--venus-or);
        width: 20px;
    }

    /* Barre de progression élégante */
    .progress-minimal {
        height: 3px;
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--venus-or), var(--venus-jaune));
        width: 0%;
        transition: width 4.8s linear;
    }
</style>

<section class="sync-section">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-7 text-center">
                
                <div class="glass-sync-card">
                    <div class="orb-container">
                        <div class="orb-core"></div>
                        <div class="orb-inner"></div>
                        <i class="fas fa-fingerprint" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--venus-or); font-size: 2rem;"></i>
                    </div>

                    <h2 class="display-6 fw-bold mb-2" style="font-family: 'Playfair Display', serif;">Connexion Lunaire</h2>
                    <p class="text-white-50">Nous synchronisons votre paiement pour la commande <span class="text-gold fw-bold">#{{ order.id }}</span>.</p>

                    <div class="sync-steps text-start">
                        <div class="step-item">
                            <i class="fas fa-mobile-alt"></i>
                            <span>Si vous avez validé sur votre téléphone (T-Money/Moov), ne fermez pas cette page.</span>
                        </div>
                        <div class="step-item">
                            <i class="fas fa-satellite-dish"></i>
                            <span>Notre passerelle <strong>BKApay</strong> interroge les serveurs sécurisés.</span>
                        </div>
                        <div class="step-item mb-0">
                            <i class="fas fa-magic"></i>
                            <span>Votre accès aux trésors spirituels sera débloqué dans un instant.</span>
                        </div>
                    </div>

                    <div class="px-4 mb-4">
                        <div class="progress-minimal">
                            <div id="progress-bar" class="progress-fill"></div>
                        </div>
                        <p class="x-small text-white-50 mt-2 italic">Analyse des flux financiers en cours...</p>
                    </div>

                    <div class="mt-4 pt-3 border-top border-secondary">
                        <p class="small text-white-50">
                            Un délai inhabituel ? <br>
                            <a href="https://wa.me/22893343403" class="text-gold text-decoration-none fw-bold">
                                <i class="fab fa-whatsapp me-1"></i> Contacter l'assistance à Lomé
                            </a>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<script>
    function checkStatus() {
        const bar = document.getElementById('progress-bar');
        bar.style.transition = "none";
        bar.style.width = "0%";
        
        setTimeout(() => { 
            bar.style.transition = "width 4.8s linear";
            bar.style.width = "100%"; 
        }, 50);

        fetch(window.location.href, { 
            headers: { 'X-Requested-With': 'XMLHttpRequest' } 
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text();
            }
        })
        .then(html => {
            // On vérifie si la réponse contient un indicateur de succès ou si le statut a changé
            if (html && (html.includes("Transaction Réussie") || html.includes("success"))) {
                window.location.reload();
            }
        })
        .catch(err => console.log("Alignement des étoiles en cours..."));
    }

    checkStatus();
    setInterval(checkStatus, 5000);
</script>
{% endblock %}