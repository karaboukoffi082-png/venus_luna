{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="py-5 d-flex align-items-center" style="background-color: #001524; min-height: 100vh;">
    <div class="container text-center">
        <div class="row justify-content-center">
            <div class="col-md-7">
                <div class="payment-loader mb-5">
                    <div class="spinner-border" role="status" style="width: 5rem; height: 5rem; color: #D4AF37; border-width: 0.25em;">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>

                <h2 class="display-6 fw-bold mb-4" style="color: #D4AF37; font-family: 'Playfair Display', serif;">
                    Validation sur votre mobile
                </h2>
                
                <div class="p-4 rounded-4 mb-4" style="background: rgba(212, 175, 55, 0.05); border: 1px solid rgba(212, 175, 55, 0.2);">
                    <p class="lead text-white mb-0">
                        Un message Push (USSD) a été envoyé au :<br>
                        <strong style="color: #D4AF37; font-size: 1.4rem;">{{ order.shipping_address.phone }}</strong>
                    </p>
                </div>

                <div class="instruction-steps text-start d-inline-block text-white opacity-75 mb-5">
                    <p class="mb-3"><i class="fas fa-mobile-alt me-3" style="color: #D4AF37;"></i> <strong>1. Déverrouillez</strong> votre téléphone.</p>
                    <p class="mb-3"><i class="fas fa-key me-3" style="color: #D4AF37;"></i> <strong>2. Saisissez votre code PIN</strong> pour valider les {{ order.total }} F.</p>
                    <p class="mb-0"><i class="fas fa-sync-alt fa-spin me-3" style="color: #D4AF37;"></i> <strong>3. Ne fermez pas</strong> cette page, elle se rafraîchira seule.</p>
                </div>

                <div class="progress mb-4" style="height: 3px; background: rgba(255,255,255,0.1);">
                    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%; background-color: #D4AF37; transition: width 5s linear;"></div>
                </div>

                <p class="small text-white-50">
                    Vous n'avez rien reçu ? Vérifiez votre signal réseau ou 
                    <a href="{% url 'orders:checkout' %}" class="text-decoration-none" style="color: #D4AF37;">réessayez ici</a>.
                </p>
            </div>
        </div>
    </div>
</section>

<script>
    // Vérification du statut toutes les 5 secondes
    function checkPaymentStatus() {
        const progressBar = document.getElementById('progress-bar');
        progressBar.style.width = "0%";
        
        // On déclenche l'animation de la barre
        setTimeout(() => { progressBar.style.width = "100%"; }, 100);

        fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => {
                // Si la vue Django redirige (vers confirm.html), on suit la redirection
                if (response.redirected) {
                    window.location.href = response.url;
                }
            })
            .catch(err => console.log("En attente de la validation..."));
    }

    // Lancement immédiat et répétition
    checkPaymentStatus();
    setInterval(checkPaymentStatus, 5000);
</script>

<style>
    .payment-loader {
        animation: pulse-gold 2s infinite ease-in-out;
    }
    @keyframes pulse-gold {
        0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(212, 175, 55, 0)); }
        50% { transform: scale(1.05); filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.4)); }
        100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(212, 175, 55, 0)); }
    }
    .instruction-steps p {
        font-size: 1.1rem;
    }
</style>
{% endblock %}